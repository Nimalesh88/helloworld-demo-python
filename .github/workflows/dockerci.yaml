name: Docker CI Pipeline
run-name: ${{github.actor}} is running out Docker CI Pipeline ðŸš€
on: push
jobs:
   docker-build-job:
     runs-on: ubuntu-latest
     steps:
       - name: Clone the code
         uses: actions/checkout@v4

       - name: Build the image
         run: docker build -t ${{ vars.DOCKERHUB_USERNAME }}/dockerdemo:v1 .

       - name: Login to Dockerhub
         uses: docker/login-action@v3
         with:
           username: ${{ vars.DOCKERHUB_USERNAME }}
           password: ${{ secrets.DOCKERHUB_TOKEN }}

       - name: Push the image
         run: docker push ${{ vars.DOCKERHUB_USERNAME }}/dockerdemo:v1

       - name: Run the container
         run: docker run --name test -itd -p 8080:8080 ${{ vars.DOCKERHUB_USERNAME }}/dockerdemo:v1

       - name: Test the container
         run: docker ps

   k8s-implementation:
    needs: docker-build-job
    runs-on: ubuntu-latest

    steps:
       - name: Clone the code
         uses: actions/checkout@v6  
 
       - name: Start minikube
         uses: medyagh/setup-minikube@latest

       - name: Try the cluster!
         run: kubectl get pods -A

       - name: Create Deployment and Service
         run: |
            kubectl apply -f mydeploy.yaml
            kubectl apply -f service.yaml
            kubectl wait --for=condition=ready pod -l app=demo
            
       - name: View Deployment and Service
         run: |
            kubectl get deployments
            kubectl get service
